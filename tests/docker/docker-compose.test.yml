services:
  # Test runner service
  test-runner:
    build:
      context: ../../
      dockerfile: tests/docker/Dockerfile.test
    container_name: nocodb-client-tests
    volumes:
      # Mount source for development (optional)
      - ../../:/app:ro
      # Mount output directory for test results
      - ../../test-results:/app/test-results
    environment:
      - PYTHONPATH=/app/src
      - CI=true
    command: >
      sh -c "
        echo '🐳 Starting NocoDB Simple Client Tests in Docker...' &&
        echo '📋 System Information:' &&
        python --version &&
        pip --version &&
        echo '📦 Installed packages:' &&
        pip list | grep -E '(pydantic|requests|pytest|black|ruff|mypy|bandit)' &&
        echo '' &&
        echo '🔄 Running all development checks...' &&
        mkdir -p test-results &&
        python scripts/run-all.py --ci 2>&1 | tee test-results/test-output.log ||
        (echo '❌ Tests failed - check test-results/test-output.log' && exit 1)
      "
    profiles:
      - testing

  # Optional: NocoDB service for integration tests
  nocodb:
    image: nocodb/nocodb:latest
    container_name: nocodb-test-db
    ports:
      - "8080:8080"
    environment:
      - NC_AUTH_JWT_SECRET=test-jwt-secret
      - NC_PUBLIC_URL=http://localhost:8080
      - NC_DISABLE_TELE=true
      - NC_MIN=true
    profiles:
      - integration

  # Integration test runner (with NocoDB)
  test-runner-integration:
    build:
      context: ../../
      dockerfile: tests/docker/Dockerfile.test
    container_name: nocodb-client-integration-tests
    depends_on:
      - nocodb
    volumes:
      - ../../:/app:ro
      - ../../test-results:/app/test-results
    environment:
      - PYTHONPATH=/app/src
      - NOCODB_BASE_URL=http://nocodb:8080
      - CI=true
    command: >
      sh -c "
        echo '🐳 Starting Integration Tests...' &&
        echo '⏳ Waiting for NocoDB to be ready...' &&
        timeout 120 sh -c 'until curl -f http://nocodb:8080/dashboard 2>/dev/null; do sleep 3; done' &&
        echo '✅ NocoDB is ready!' &&
        mkdir -p test-results &&
        python scripts/run-all.py --integration 2>&1 | tee test-results/integration-test-output.log ||
        (echo '❌ Integration tests failed' && exit 1)
      "
    profiles:
      - integration
